<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Guardians Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        /* AnimaciÃ³n suave para el contenido */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Scrollbar personalizado */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans antialiased flex h-screen overflow-hidden">

    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2"></div>

    <aside class="w-64 bg-gray-800 border-r border-gray-700 flex-shrink-0 hidden md:flex flex-col">
        <div class="p-6 flex items-center gap-3 border-b border-gray-700">
            <div class="bg-yellow-600 p-2 rounded-lg text-white"><i class="ri-shield-star-line text-xl"></i></div>
            <div>
                <h1 class="font-bold text-lg tracking-wide">ADMIN PANEL</h1>
                <p class="text-xs text-gray-400">Guardians Shop</p>
            </div>
        </div>

        <nav class="flex-grow p-4 space-y-2">
            <button onclick="showTab('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-700 transition-all text-left bg-gray-700 text-yellow-500">
                <i class="ri-dashboard-line"></i> Resumen
            </button>
            <button onclick="showTab('products')" id="nav-products" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-700 transition-all text-left text-gray-300">
                <i class="ri-shopping-bag-3-line"></i> Productos
            </button>
            <button onclick="showTab('orders')" id="nav-orders" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-700 transition-all text-left text-gray-300">
                <i class="ri-file-list-3-line"></i> Ã“rdenes
            </button>
        </nav>

        <div class="p-4 border-t border-gray-700">
            <a href="/" class="flex items-center gap-2 text-gray-400 hover:text-white transition-colors">
                <i class="ri-arrow-left-line"></i> Volver a la Tienda
            </a>
        </div>
    </aside>

    <main class="flex-grow overflow-y-auto h-full bg-gray-900 relative">
        <div class="md:hidden bg-gray-800 p-4 flex justify-between items-center border-b border-gray-700 sticky top-0 z-10">
            <span class="font-bold text-yellow-500">Guardians Admin</span>
            <div class="flex gap-3">
                <button onclick="showTab('products')" class="p-2 bg-gray-700 rounded"><i class="ri-shopping-bag-line"></i></button>
                <button onclick="showTab('orders')" class="p-2 bg-gray-700 rounded"><i class="ri-list-unordered"></i></button>
                <a href="/" class="p-2 bg-gray-700 rounded text-red-400"><i class="ri-logout-box-r-line"></i></a>
            </div>
        </div>

        <div class="p-6 md:p-10 max-w-7xl mx-auto">
            
            <div id="tab-dashboard" class="fade-in">
                <h2 class="text-3xl font-bold mb-6">ðŸ‘‹ Bienvenido, Admin</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700 shadow-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-gray-400 text-sm font-medium">Productos Activos</p>
                                <h3 class="text-3xl font-bold mt-2 text-white" id="stat-products">0</h3>
                            </div>
                            <div class="bg-blue-900/30 p-3 rounded-lg text-blue-400">
                                <i class="ri-box-3-line text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700 shadow-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-gray-400 text-sm font-medium">Ventas Totales</p>
                                <h3 class="text-3xl font-bold mt-2 text-white" id="stat-sales">0</h3>
                            </div>
                            <div class="bg-green-900/30 p-3 rounded-lg text-green-400">
                                <i class="ri-money-dollar-circle-line text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700 shadow-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-gray-400 text-sm font-medium">Entregas Fallidas</p>
                                <h3 class="text-3xl font-bold mt-2 text-white" id="stat-failed">0</h3>
                            </div>
                            <div class="bg-red-900/30 p-3 rounded-lg text-red-400">
                                <i class="ri-error-warning-line text-xl"></i>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Requieren atenciÃ³n manual</p>
                    </div>
                </div>
            </div>

            <div id="tab-products" class="hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">ðŸ“¦ GestiÃ³n de Productos</h2>
                    <button onclick="document.getElementById('productFormContainer').classList.toggle('hidden')" class="bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors">
                        <i class="ri-add-circle-line"></i> Nuevo Producto
                    </button>
                </div>

                <div id="productFormContainer" class="hidden bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-xl mb-8">
                    <h3 class="text-lg font-semibold mb-4 text-yellow-500 border-b border-gray-700 pb-2">Crear / Editar Producto</h3>
                    <form id="addProductForm" class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        
                        <div class="space-y-1">
                            <label class="text-xs text-gray-400 uppercase font-bold">Nombre Visible</label>
                            <input type="text" name="nombre" placeholder="Ej: VIP Gold" class="w-full bg-gray-900 border border-gray-600 p-2.5 rounded-lg focus:border-yellow-500 focus:outline-none transition-colors" required>
                        </div>

                        <div class="space-y-1">
                            <label class="text-xs text-gray-400 uppercase font-bold">SKU (Identificador Ãºnico)</label>
                            <input type="text" name="sku" placeholder="Ej: vip_gold_30d" class="w-full bg-gray-900 border border-gray-600 p-2.5 rounded-lg focus:border-yellow-500 focus:outline-none transition-colors" required>
                        </div>

                        <div class="space-y-1">
                            <label class="text-xs text-gray-400 uppercase font-bold">Precio (ARS)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2.5 text-gray-500">$</span>
                                <input type="number" name="precio" placeholder="1500" class="w-full bg-gray-900 border border-gray-600 p-2.5 pl-7 rounded-lg focus:border-yellow-500 focus:outline-none transition-colors" required>
                            </div>
                        </div>

                        <div class="space-y-1">
                            <label class="text-xs text-gray-400 uppercase font-bold">Stock (-1 = Infinito)</label>
                            <input type="number" name="stock" value="-1" class="w-full bg-gray-900 border border-gray-600 p-2.5 rounded-lg focus:border-yellow-500 focus:outline-none transition-colors">
                        </div>
                        
                        <div class="space-y-1">
                            <label class="text-xs text-gray-400 uppercase font-bold">CategorÃ­a</label>
                            <select name="categoria" class="w-full bg-gray-900 border border-gray-600 p-2.5 rounded-lg focus:border-yellow-500 focus:outline-none transition-colors">
                                <option value="vips">VIPs</option>
                                <option value="kits">Kits</option>
                                <option value="dinos">Dinos</option>
                                <option value="blueprints">Blueprints</option>
                                <option value="tribelog">Tribe Log</option>
                            </select>
                        </div>
                        
                        <div class="space-y-1">
                            <label class="text-xs text-gray-400 uppercase font-bold">Emoji / Icono</label>
                            <input type="text" name="emoji" placeholder="ðŸ‘‘" class="w-full bg-gray-900 border border-gray-600 p-2.5 rounded-lg focus:border-yellow-500 focus:outline-none transition-colors">
                        </div>

                        <div class="col-span-1 md:col-span-2 space-y-1">
                            <label class="text-xs text-gray-400 uppercase font-bold flex items-center gap-2">
                                Comando RCON <i class="ri-information-line text-blue-400" title="Usa {player} donde irÃ­a el nombre del jugador."></i>
                            </label>
                            <input type="text" name="rconCommand" placeholder="giveitemnum {player} 1 1 0" class="w-full bg-gray-950 border border-gray-700 p-3 rounded-lg font-mono text-sm text-green-400 focus:border-green-600 focus:outline-none transition-colors" required>
                            <p class="text-xs text-gray-500">Variable disponible: <code class="text-gray-300">{player}</code> (Nombre del usuario)</p>
                        </div>

                        <div class="col-span-1 md:col-span-2 space-y-1">
                            <label class="text-xs text-gray-400 uppercase font-bold">DescripciÃ³n</label>
                            <textarea name="descripcion" rows="2" class="w-full bg-gray-900 border border-gray-600 p-2.5 rounded-lg focus:border-yellow-500 focus:outline-none transition-colors"></textarea>
                        </div>
                        
                        <div class="col-span-1 md:col-span-2 flex justify-end gap-3 mt-2">
                            <button type="button" onclick="document.getElementById('productFormContainer').classList.add('hidden')" class="px-4 py-2 text-gray-400 hover:text-white transition-colors">Cancelar</button>
                            <button type="submit" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg transform active:scale-95 transition-all">
                                Guardar Producto
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden shadow-lg">
                    <table class="w-full text-left text-sm text-gray-400">
                        <thead class="bg-gray-700 text-gray-200 uppercase font-medium">
                            <tr>
                                <th class="px-6 py-4">Producto</th>
                                <th class="px-6 py-4">CategorÃ­a</th>
                                <th class="px-6 py-4">Precio</th>
                                <th class="px-6 py-4">Stock</th>
                                <th class="px-6 py-4 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productsList" class="divide-y divide-gray-700">
                            <tr><td colspan="5" class="px-6 py-8 text-center"><i class="ri-loader-4-line animate-spin text-2xl"></i> Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="tab-orders" class="hidden fade-in">
                <h2 class="text-2xl font-bold mb-6">ðŸ“œ Historial de Ventas</h2>
                
                <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden shadow-lg">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-gray-400">
                            <thead class="bg-gray-700 text-gray-200 uppercase font-medium">
                                <tr>
                                    <th class="px-6 py-4">ID Pago</th>
                                    <th class="px-6 py-4">Usuario</th>
                                    <th class="px-6 py-4">Producto</th>
                                    <th class="px-6 py-4">Fecha</th>
                                    <th class="px-6 py-4 text-center">Estado RCON</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody" class="divide-y divide-gray-700">
                                <tr><td colspan="5" class="px-6 py-8 text-center">Cargando Ã³rdenes...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- UTILITIES: TOAST NOTIFICATIONS ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = type === 'success' ? 'bg-green-600' : (type === 'error' ? 'bg-red-600' : 'bg-blue-600');
            const icon = type === 'success' ? 'ri-checkbox-circle-line' : (type === 'error' ? 'ri-error-warning-line' : 'ri-information-line');

            toast.className = `${colors} text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3 min-w-[300px] transform transition-all duration-500 translate-x-full opacity-0`;
            toast.innerHTML = `<i class="${icon} text-xl"></i> <span class="font-medium">${message}</span>`;

            container.appendChild(toast);

            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            });

            // Remove after 3s
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        // --- DATA LOADING ---

        async function loadProducts() {
            try {
                const res = await fetch('/api/products');
                const data = await res.json();
                const allProducts = [...data.vips, ...data.kits, ...data.dinos, ...data.blueprints, ...data.tribelog];
                
                const tbody = document.getElementById('productsList');
                document.getElementById('stat-products').innerText = allProducts.length;

                tbody.innerHTML = allProducts.map(p => `
                    <tr class="hover:bg-gray-750 transition-colors group">
                        <td class="px-6 py-4 font-medium text-white flex items-center gap-3">
                            <span class="text-2xl">${p.emoji || 'ðŸ“¦'}</span>
                            <div>
                                <div>${p.nombre}</div>
                                <div class="text-xs text-gray-500 font-mono">${p.sku}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="bg-gray-700 px-2 py-1 rounded text-xs uppercase tracking-wider">${p.category}</span>
                        </td>
                        <td class="px-6 py-4 text-green-400 font-bold">$${p.precio}</td>
                        <td class="px-6 py-4">
                            ${p.stock === -1 ? '<span class="text-blue-400">âˆž Infinito</span>' : (p.stock > 0 ? p.stock : '<span class="text-red-500">Agotado</span>')}
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="deleteProduct('${p._id}')" class="text-gray-500 hover:text-red-500 transition-colors p-2 rounded-full hover:bg-red-900/20" title="Eliminar">
                                <i class="ri-delete-bin-line text-lg"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error(e);
                showToast('Error cargando productos', 'error');
            }
        }

        async function loadOrders() {
            try {
                const res = await fetch('/api/admin/orders');
                if (!res.ok) return; 
                const orders = await res.json();

                document.getElementById('stat-sales').innerText = orders.length;
                document.getElementById('stat-failed').innerText = orders.filter(o => o.deliveryStatus === 'failed').length;

                const tbody = document.getElementById('ordersTableBody');
                tbody.innerHTML = orders.map(o => {
                    const date = new Date(o.createdAt).toLocaleDateString('es-ES', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    
                    let statusBadge = '';
                    if(o.deliveryStatus === 'delivered') statusBadge = '<span class="bg-green-900 text-green-300 px-2 py-1 rounded-full text-xs border border-green-700 flex w-fit mx-auto items-center gap-1"><i class="ri-check-line"></i> Entregado</span>';
                    else if(o.deliveryStatus === 'failed') statusBadge = '<span class="bg-red-900 text-red-300 px-2 py-1 rounded-full text-xs border border-red-700 flex w-fit mx-auto items-center gap-1"><i class="ri-close-line"></i> Error</span>';
                    else statusBadge = '<span class="bg-yellow-900 text-yellow-300 px-2 py-1 rounded-full text-xs border border-yellow-700 flex w-fit mx-auto items-center gap-1"><i class="ri-loader-4-line animate-spin"></i> Pendiente</span>';

                    return `
                    <tr class="hover:bg-gray-750">
                        <td class="px-6 py-4 font-mono text-xs text-gray-500">${o.paymentId}</td>
                        <td class="px-6 py-4 font-medium text-white">${o.user ? o.user.displayName : 'Desconocido'}</td>
                        <td class="px-6 py-4">${o.productName || o.item}</td>
                        <td class="px-6 py-4 text-xs">${date}</td>
                        <td class="px-6 py-4 text-center">${statusBadge}</td>
                    </tr>
                `}).join('');
            } catch (e) {
                console.error(e);
            }
        }

        // --- ACTIONS ---

        document.getElementById('addProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            // Loading state
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.innerText = "Guardando...";
            btn.disabled = true;

            try {
                const res = await fetch('/api/admin/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    showToast('Â¡Producto guardado correctamente!');
                    e.target.reset();
                    document.getElementById('productFormContainer').classList.add('hidden');
                    loadProducts();
                } else {
                    const err = await res.json();
                    showToast(err.message || 'Error al guardar', 'error');
                }
            } catch (error) {
                showToast('Error de conexiÃ³n', 'error');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });

        async function deleteProduct(id) {
            if(!confirm('Â¿EstÃ¡s seguro de eliminar este producto? No se puede deshacer.')) return;
            
            try {
                const res = await fetch(`/api/admin/products/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    showToast('Producto eliminado', 'success');
                    loadProducts();
                } else {
                    showToast('No se pudo eliminar', 'error');
                }
            } catch (e) {
                showToast('Error al conectar con el servidor', 'error');
            }
        }

        // --- NAVIGATION LOGIC ---

        function showTab(tabName) {
            // Hide all tabs
            ['dashboard', 'products', 'orders'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden');
                // Update nav styles
                const navBtn = document.getElementById(`nav-${t}`);
                if (navBtn) {
                    if (t === tabName) {
                        navBtn.classList.remove('text-gray-300', 'bg-transparent');
                        navBtn.classList.add('bg-gray-700', 'text-yellow-500');
                    } else {
                        navBtn.classList.add('text-gray-300');
                        navBtn.classList.remove('bg-gray-700', 'text-yellow-500');
                    }
                }
            });

            // Show selected tab
            const selected = document.getElementById(`tab-${tabName}`);
            selected.classList.remove('hidden');
            
            // Reload data if necessary
            if (tabName === 'products') loadProducts();
            if (tabName === 'orders') loadOrders();
        }

        // Init
        loadProducts();
        loadOrders();
    </script>
</body>
</html>